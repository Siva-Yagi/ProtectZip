<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パスワード付きZIP作成（Safari対応）</title>
  <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.6.21/dist/zip.min.js"></script>
</head>
<body>
  <h1>ZIPファイルにパスワードを設定</h1>
  <input type="file" id="fileInput" accept=".zip"><br>
  <input type="password" id="password" placeholder="パスワード"><br>
  <button id="btn">パスワードを設定</button>

  <script>
    document.getElementById('btn').addEventListener('click', async () => {
      const input = document.getElementById('fileInput');
      const pwd = document.getElementById('password').value;
      if (!input.files.length || !pwd) { alert('入力に不備があります'); return; }

      try {
        // ZIP生成
        const reader = new zip.BlobReader(input.files[0]);
        const writer = new zip.BlobWriter('application/zip');
        const zipWriter = new zip.ZipWriter(writer, { password: pwd, bufferedWrite: false });
        const zipReader = new zip.ZipReader(reader);

        for (const entry of await zipReader.getEntries()) {
          await zipWriter.add(entry.filename, entry.getData(new zip.BlobWriter()));
        }
        await zipWriter.close();
        const blob = await writer.getData();

        // Safari対応分岐
        const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
        if (isSafari) {
          const fr = new FileReader();
          fr.onload = () => triggerDownload(fr.result);
          fr.readAsDataURL(blob);
        } else {
          const url = URL.createObjectURL(blob);
          triggerDownload(url);
          URL.revokeObjectURL(url);
        }
      } catch (e) {
        console.error(e);
        alert('ダウンロードに失敗しました');
      }
    });

    function triggerDownload(url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'protected.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
