<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãZIPä½œæˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.6.21/dist/zip.min.js"></script>
</head>
<body>
  <h1>ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š</h1>
  <input type="file" id="fileInput" accept=".zip"><br>
  <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button id="btn">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š</button>

  <div id="manualDownload" style="margin-top:20px;"></div>

  <script>
    document.getElementById('btn').addEventListener('click', addPasswordToZip);

    async function addPasswordToZip() {
      const input = document.getElementById('fileInput');
      const pwd = document.getElementById('password').value;
      const manualDiv = document.getElementById('manualDownload');
      manualDiv.innerHTML = '';

      if (!input.files.length || !pwd) {
        alert('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const reader = new zip.BlobReader(input.files[0]);
        const writer = new zip.BlobWriter('application/zip'); // ğŸ”‘ MIMEæŒ‡å®š
        const zipWriter = new zip.ZipWriter(writer, {
          password: pwd,
          bufferedWrite: false // ğŸ”‘ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆç’°å¢ƒä¾å­˜ã®ä¸å…·åˆå¯¾å¿œï¼‰
        });
        const zipReader = new zip.ZipReader(reader);

        const entries = await zipReader.getEntries();
        for (const entry of entries) {
          await zipWriter.add(entry.filename, entry.getData(new zip.BlobWriter()));
        }
        await zipWriter.close();

        const blob = await writer.getData(); // ğŸ”‘ await å¿…é ˆ before download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'protected.zip';
        document.body.appendChild(a); // ğŸ§· Safariå¯¾å¿œ
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

      } catch (err) {
        console.error(err);
        manualDiv.innerHTML = `
          <p>è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‹ã‚‰æ‰‹å‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š</p>
          <button id="manualLink">æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>`;

        document.getElementById('manualLink').addEventListener('click', async () => {
          const reader = new zip.BlobReader(input.files[0]);
          const writer = new zip.BlobWriter('application/zip');
          const zipWriter = new zip.ZipWriter(writer, {
            password: pwd,
            bufferedWrite: false
          });
          const zipReader = new zip.ZipReader(reader);

          const entries = await zipReader.getEntries();
          for (const entry of entries) {
            await zipWriter.add(entry.filename, entry.getData(new zip.BlobWriter()));
          }
          await zipWriter.close();

          const blob = await writer.getData();
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'protected.zip';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        });
      }
    }
  </script>
</body>
</html>
