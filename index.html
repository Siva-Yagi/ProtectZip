<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>パスワード付きZIP作成</title>
  <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.6.21/dist/zip.min.js"></script>
</head>
<body>
  <h1>ZIPファイルにパスワードを設定</h1>
  <input type="file" id="fileInput" accept=".zip"><br>
  <input type="password" id="password" placeholder="パスワード"><br>
  <button id="btn">パスワードを設定</button>
  <div id="manualDownload" style="margin-top:20px;"></div>

  <script>
    document.getElementById('btn').addEventListener('click', addPasswordToZip);

    async function addPasswordToZip() {
      const input = document.getElementById('fileInput');
      const pwd = document.getElementById('password').value;
      const manualDiv = document.getElementById('manualDownload');
      manualDiv.innerHTML = '';

      if (!input.files.length || !pwd) {
        alert('ZIPファイルとパスワードを入力してください');
        return;
      }

      try {
        const reader = new zip.BlobReader(input.files[0]);
        const writer = new zip.BlobWriter('application/zip');
        const zipWriter = new zip.ZipWriter(writer, {
          password: pwd,
          bufferedWrite: false
        });
        const zipReader = new zip.ZipReader(reader);

        const entries = await zipReader.getEntries();
        for (const entry of entries) {
          await zipWriter.add(entry.filename, entry.getData(new zip.BlobWriter()));
        }
        await zipWriter.close();

        const blob = await writer.getData();

        // Safari対応の分岐
        if (navigator.userAgent.match(/Safari/) && !navigator.userAgent.match(/Chrome/)) {
          const fileReader = new FileReader();
          fileReader.onload = () => {
            triggerDownload(fileReader.result);
          };
          fileReader.readAsDataURL(blob);
        } else {
          const url = URL.createObjectURL(blob);
          triggerDownload(url);
          URL.revokeObjectURL(url);
        }
      } catch (err) {
        console.error(err);
        manualDiv.innerHTML = `
          <p>自動ダウンロードに失敗しました。手動でダウンロードしてください：</p>
          <button id="manualLink">手動ダウンロード</button>`;
        document.getElementById('manualLink').addEventListener('click', () =>
          addPasswordToZip()); // 再実行される
      }
    }

    function triggerDownload(url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'protected.zip';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
